<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../ugo-resumer/ugo-resumer.html">

<dom-module id="ugo-fieldset">
    <link rel="stylesheet" href="ugo-fieldset.css">
    <style>
        .ugo-fieldset-content {
            background-color: #f1f1f1;
            border-radius: 3px;
            margin: 30px 0 0;
        }

        .ugo-fieldset-content .core-collapse-container {
            padding: 20px 30px;
        }

        .ugo-fieldset-resume.showed {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #fff;
            padding: 0 10px;
        }
    </style>
    <template>

        <fieldset  class="ugo-fieldset">
            <legend>
                <button id="ugoFieldsetButton" type="button" class="ugo-fieldset-btn" on-tap="onTap">
                    <span aria-hidden="true">{{buttonText}}</span>
                </button>
                <span aria-label="true">{{legend}}</span>
            </legend>

            <hr class="ugo-fieldset-border">

            <ugo-resumer id="fldsResumer" class="ugo-fieldset-resume">
                <core-collapse id="fldsCollapse" opened="{{opened}}" allowOverflow class="ugo-fieldset-content">
                    <div class="core-collapse-container">
                        <content></content>
                    </div>
                </core-collapse>
            </ugo-resumer>
        </fieldset>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'ugo-fieldset',

        properties: {
            /**
             * Open status for core-collapse
             */
            opened: {
                type: Boolean,
                value: false,
                observer: 'openedChanged'
            },

            /**
             * Prevent form submission
             */
            preventSubmission: {
                type: Boolean,
                value: false
            },

            errorClass: {
                type: String,
                value: 'has-error'
            },

            successClass: {
                type: String,
                value: 'has-success'
            },

            /**
             * Fieldset legend (title)
             */
            legend: {
                type: String,
                notify: true
            }
        },

        /**
         * @type {HTMLFormElement|null}
         */
        form: null,

        /**
         * @type {String}
         */
        buttonText: null,

        /**
         * Constructor
         */
        ready: function() {
            this.setResumerData();
            this.$.fldsCollapse.addEventListener('transitionend', this.onCollapseTransitionEnd.bind(this));

            this.form = this.getParentForm();
            if (this.form) {
                if (this.preventSubmission) {
                    this.form.noValidate = true;
                }
                this.form.addEventListener('submit', this.onFormSubmit.bind(this));
            }
        },

        /**
         * Remove listener when removing item
         */
        detached: function() {
            this.collapse.removeEventListener('core-resize');
        },

        /**
         * onTap event switch opened
         */
        onTap: function() {
            this.opened = !this.opened;
        },

        /**
         * On opened property change
         */
        openedChanged: function() {
            if (this.opened) this.setResumerData();
            this.buttonText = this.opened ? '-' : '+';
        },

        /**
         * Get parent form
         *
         * @return {HTMLFormElement}
         */
        getParentForm: function () {
            var p = this.parentNode, o;

            while (p !== null) {
                o = p;
                if (o.tagName === 'FORM') {
                    return o;
                }

                p = o.parentNode;
            }

            return null;
        },

        /**
         * Form submit
         */
        onFormSubmit: function(event) {
            var isValid = this.isValid();
            if (!isValid) {
                this.opened = true;
            }

            if (this.preventSubmission && !isValid) {
                event.preventDefault();
            }
        },

        /**
         * Check fields validity
         */
        isValid: function() {
            var validity = true,
                parent,
                elements = Polymer.dom(this).querySelectorAll('input, textarea, select')
            ;

            [].forEach.call(elements, function(element) {
                if (element.getAttribute('parent-selector')) {
                    parent = this.querySelector(element.getAttribute('parent-selector'));
                } else {
                    parent = element.parentNode;
                }

                if (!element.validity.valid) {
                    validity = false;
                    parent.classList.remove(this.successClass);
                    parent.classList.add(this.errorClass);
                } else {
                    parent.classList.add(this.successClass);
                    parent.classList.remove(this.errorClass);
                }
            }.bind(this));

            return validity;
        },

        /**
         * Set resumer class and opened property with the fieldset opened property
         */
        setResumerData: function() {
            this.$.fldsResumer.opened = !this.opened;
            this.$.fldsResumer.classList[(this.opened ? 'remove' : 'add')]('showed');
        },

        /**
         * On core-collapse transition end
         */
        onCollapseTransitionEnd: function() {
            if (!this.opened) this.setResumerData();
        }
    });
</script>